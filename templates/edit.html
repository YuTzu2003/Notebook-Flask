<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç·¨è¼¯æ¨¡å¼ - PDFåšç­†è¨˜</title> 
    <link rel="icon" href="/static/logo.ico" type="image/x-icon"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf_viewer.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';</script> 
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="/static/css/edit.css"> 
<!-- <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet"> -->  
</head>
<body class="mode-text-select">
    <div id="hoverPreview">
        <div class="preview-text" id="previewText"></div>
        <img id="previewImg" src="" style="display:none;">
    </div>

    <div class="container-fluid p-0">
        <div class="row g-0 h-100">
            <div class="col-md-3 col-lg-2 sidebar">
                <div class="sidebar-header d-flex align-items-center justify-content-center py-3 border-bottom">
                    <a class="navbar-brand d-flex align-items-center gap-2 text-decoration-none" href="/">
                        <h5 class="m-0 fw-bold text-dark"><img src="/static/logo.png" alt="logo" style="height: 40px;">PDFåšç­†è¨˜</h5>
                    </a>
                </div>

                <div class="sidebar-content d-flex flex-column p-3">          
                    <div class="sidebar-panel mb-4">
                        <div class="d-grid gap-2">
                            <button class="btn btn-dark btn-sm fw-bold shadow-sm" onclick="addBlankPage()">
                                <i class="bi bi-plus-square me-2"></i>æ’å…¥ç©ºç™½é 
                            </button>
                            <button class="btn btn-outline-danger btn-sm fw-bold shadow-sm" onclick="deleteCurrentPage()">
                                <i class="bi bi-trash3 me-2"></i>åˆªé™¤æ­¤é 
                            </button>
                        </div>
                    </div>

                    <div class="sidebar-panel d-flex flex-column h-100">
                        <div class="mb-3">
                            <label class="form-label small text-muted">ç›®éŒ„é ç¢¼ç¯„åœ</label>
                            <input type="text" id="tocRange" class="form-control form-control-sm" value="3-5">
                        </div>
                        <div class="mb-3">
                            <label class="form-label small text-muted">é ç¢¼åç§»é‡</label>
                            <input type="number" id="pageOffset" class="form-control form-control-sm" value="0">
                        </div>
                        <button class="btn btn-success btn-sm w-100 fw-bold mb-3 shadow-sm" onclick="analyzeStructure()">æ›¸ç±¤è£½ä½œ</button>
                        <div class="list-group list-group-flush border rounded overflow-auto shadow-sm" id="resultList" style="flex:1; min-height: 200px;">
                            <div class="p-4 text-center text-muted small bg-light">æœªè£½ä½œæ›¸ç±¤</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-9 col-lg-10 main-wrapper">
                <div class="toolbar-top d-flex align-items-center justify-content-between px-3 py-2">
                    <div class="d-flex align-items-center gap-3">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-file-text me-2 text-primary fs-5"></i>
                            <span id="fileNameDisplay" class="fw-bold text-dark text-truncate small" style="max-width:200px;">è¼‰å…¥ä¸­...</span>
                        </div>
                        <div class="vr mx-1"></div>
                        <div class="toolbar-group bg-white rounded border px-2 d-flex align-items-center">
                             <button class="btn btn-sm btn-link text-secondary" onclick="adjustZoom(-0.1)"><i class="bi bi-zoom-out"></i></button>
                             <span id="zoomLevel" class="small fw-bold text-muted mx-1" style="min-width:40px; text-align:center;">100%</span>
                             <button class="btn btn-sm btn-link text-secondary" onclick="adjustZoom(0.1)"><i class="bi bi-zoom-in"></i></button>
                             <div class="vr mx-2"></div>
                             <button class="btn btn-sm btn-link text-secondary" onclick="fitToWidth()" title="ç¬¦åˆå¯¬åº¦"><i class="bi bi-arrows-fullscreen"></i></button>
                        </div>
                    </div>

                    <div class="position-absolute start-50 translate-middle-x d-flex align-items-center bg-light rounded px-2 py-1 border page-control-group" style="z-index: 10;">
                        <button class="btn btn-sm btn-link text-dark p-0 me-2" onclick="changePage(-1)"><i class="bi bi-chevron-left"></i></button>
                        <span id="pageInfo" class="text-dark small mx-2 fw-bold" style="min-width: 60px; text-align: center;">0 / 0</span>
                        <button class="btn btn-sm btn-link text-dark p-0 ms-2 me-3" onclick="changePage(1)"><i class="bi bi-chevron-right"></i></button>
                        
                        <div class="input-group input-group-sm" style="width: 100px;">
                            <input type="number" id="jumpPage" class="form-control text-center" min="1" placeholder="#">
                            <button class="btn btn-outline-secondary" onclick="jumpToPage()">Go</button>
                        </div>
                    </div>

                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-success btn-sm px-3 fw-bold" onclick="save(this)">å„²å­˜</button>
                        <button class="btn btn-primary btn-sm px-3 fw-bold" onclick="download(this)">ä¸‹è¼‰</button>
                    </div>
                </div>

                <div id="wrap">
                    <div id="pageStack" class="page-stack">
                        <canvas id="pdfCanvas" class="pdf-render-canvas"></canvas>
                        <div id="textLayer" class="textLayer"></div>
                        <canvas id="c"></canvas>
                    </div>
                </div>

                <div class="toolbar-bottom d-flex align-items-center justify-content-center gap-3">
                    <div class="d-flex align-items-center gap-2">
                        <select id="fontFamily" class="form-select form-select-sm shadow-sm" style="width: 120px;" onchange="updateStyle('font')">
                            <option value="Noto Sans TC">æ€æºé»‘é«”</option>
                            <option value="Microsoft JhengHei">å¾®è»Ÿæ­£é»‘é«”</option>
                            <option value="Times New Roman" selected>Times New Roman</option>
                        </select>
                        <div class="d-flex align-items-center gap-2">                         
                            <input type="number" id="mainSize" value="3" class="form-control form-control-sm text-center shadow-sm" oninput="updateStyle('size')" style="width:60px" title="å¤§å°/ç²—ç´°">
                            <input type="color" id="mainColor" value="#ffeb3b" class="form-control form-control-color form-control-sm border-0 shadow-sm" oninput="updateStyle('color')" title="é¡è‰²">
                        </div>
                        <button id="boldBtn" class="btn btn-outline-secondary btn-sm shadow-sm" onclick="toggleBold()"><i class="bi bi-type-bold"></i></button>
                        <button id="underlineBtn" class="btn btn-outline-dark btn-sm shadow-sm" onclick="toggleUnderlineMode()" title="åº•ç·šæ¨¡å¼ï¼šé¸å–æ–‡å­—è‡ªå‹•åŠ åº•ç·š">
                            <i class="bi bi-type-underline"></i>
                        </button>
                    </div>
                    <div class="vr mx-1"></div>
                    <div class="btn-group shadow-sm">
                        <button id="highlightBtn" class="btn btn-outline-secondary btn-sm px-3 shadow-sm" onclick="toggleHighlightMode()"><i class="bi bi-highlighter"></i>è¢å…‰ç­†</button>
                        <button id="drawBtn" class="btn btn-outline-secondary btn-sm px-3" onclick="toggleDrawMode()"><i class="bi bi-pen"></i> ç¹ªåœ–</button>
                        <button id="textBtn" class="btn btn-outline-secondary btn-sm px-3" onclick="addText()"><i class="bi bi-type"></i> æ–‡å­—</button>
                        <button id="stickyBtn" class="btn btn-outline-secondary btn-sm px-3" onclick="toggleStickyMode()"><i class="bi bi-chat-square-dots"></i> ä¾¿ç±¤</button>
                        <button class="btn btn-outline-secondary btn-sm px-3" onclick="document.getElementById('imgInput').click()"><i class="bi bi-image"></i> åœ–ç‰‡</button>
                    </div>
                    <input type="file" id="imgInput" hidden accept="image/*">
                    <div class="vr mx-1"></div>
                    <button id="selectObjBtn" class="btn btn-outline-info btn-sm px-3 shadow-sm" onclick="toggleSelectObjectMode()"><i class="bi bi-cursor"></i></button>
                    <button class="btn btn-outline-secondary btn-sm shadow-sm px-3" onclick="selectAll()" title="å…¨é¸ (Ctrl+A)">å…¨é¸</button>
                    <button class="btn btn-outline-danger btn-sm shadow-sm px-3" onclick="deleteObj()">åˆªé™¤</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="noteModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered modal-sm">
            <div class="modal-content shadow border-0">
                <div class="modal-header bg-warning text-dark border-0 py-2">
                    <h6 class="modal-title fw-bold"><i class="bi bi-sticky me-2"></i>ä¾¿ç±¤å…§å®¹èˆ‡é™„ä»¶</h6>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <textarea id="noteTextContent" class="form-control mb-3" rows="4" placeholder="è¼¸å…¥è©³ç´°å…§å®¹..."></textarea>
                    <div id="noteImagePreviewContainer" class="text-center mb-2" style="display:none;">
                        <img id="noteImagePreview" class="img-thumbnail w-100" style="max-height: 150px; object-fit: contain;">
                        <button type="button" class="btn btn-sm btn-link text-danger text-decoration-none" onclick="removeNoteImage()">ç§»é™¤é™„ä»¶</button>
                    </div>
                    <button type="button" class="btn btn-outline-dark btn-sm w-100" onclick="document.getElementById('noteImgInput').click()">
                        <i class="bi bi-image me-1"></i>ä¸Šå‚³åœ–ç‰‡é™„ä»¶
                    </button>
                    <input type="file" id="noteImgInput" hidden accept="image/*" onchange="handleNoteImgChange(this)">
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-dark btn-sm w-100" onclick="saveStickyContent()">ç¢ºèªå„²å­˜</button>
                </div>
            </div>
        </div>
    </div>

    
    <script>
        const canvas = new fabric.Canvas("c", { preserveObjectStacking: true });
        
        let pdfDoc = null, pdfDataInfo = null;
        let pageNum = 1, scale = 1.0; 
        let isStickyMode = false, currentNoteObj = null, tempNoteImage = null;
        const noteModal = new bootstrap.Modal(document.getElementById('noteModal'));
        
        let interactionMode = 'text'; // 'text', 'highlight', 'underline', 'draw', 'object', 'sticky'

        const hoverBox = document.getElementById('hoverPreview');
        const previewTxt = document.getElementById('previewText');
        const previewImg = document.getElementById('previewImg');

        window.onload = async function() {
            const storedData = localStorage.getItem("currentPdfSession");
            if (!storedData) { alert("è«‹å…ˆä¸Šå‚³æª”æ¡ˆ"); window.location.href = "/"; return; }
            pdfDataInfo = JSON.parse(storedData);
            document.getElementById("fileNameDisplay").innerText = pdfDataInfo.original_name;
            updateStyle('init');

            const loadingTask = pdfjsLib.getDocument(`/get_pdf_content/${pdfDataInfo.doc_id}`);
            pdfDoc = await loadingTask.promise;
            pdfDataInfo.total_pages = pdfDoc.numPages;
            renderPage(pageNum);
        };

        async function renderPage(num) {
            if(num < 1 || num > pdfDoc.numPages) return;
            
            if(pdfDataInfo.mods && pageNum !== num) saveCurrent();
            pageNum = num;
            
            const page = await pdfDoc.getPage(num);
            const dpr = window.devicePixelRatio || 1;

            const viewportDisplay = page.getViewport({ scale: scale });
            const viewportRender = page.getViewport({ scale: scale * dpr });
            
            const stack = document.getElementById("pageStack");
            stack.style.width = `${viewportDisplay.width}px`;
            stack.style.height = `${viewportDisplay.height}px`;

            const pdfCanvas = document.getElementById("pdfCanvas");
            const pdfCtx = pdfCanvas.getContext('2d');
            
            pdfCanvas.width = viewportRender.width;
            pdfCanvas.height = viewportRender.height;
            pdfCanvas.style.width = `${viewportDisplay.width}px`;
            pdfCanvas.style.height = `${viewportDisplay.height}px`;
            
            await page.render({ canvasContext: pdfCtx, viewport: viewportRender }).promise;

            const textLayerDiv = document.getElementById("textLayer");
            textLayerDiv.innerHTML = ""; 
            textLayerDiv.style.width = `${viewportDisplay.width}px`;
            textLayerDiv.style.height = `${viewportDisplay.height}px`;
            
            const textContent = await page.getTextContent();
            pdfjsLib.renderTextLayer({
                textContent: textContent,
                container: textLayerDiv,
                viewport: viewportDisplay,
                textDivs: []
            });

            canvas.setWidth(viewportDisplay.width);
            canvas.setHeight(viewportDisplay.height);
            canvas.setZoom(scale); 
            canvas.clear(); 

            if (pdfDataInfo.mods && pdfDataInfo.mods[num-1]) {
                fabric.util.enlivenObjects(pdfDataInfo.mods[num-1], objs => {
                    objs.forEach(o => {
                        if(o.data_type === 'sticky') o.set({hasControls:true, editable:false});
                        if(o.data_type === 'highlight' || o.data_type === 'underline') {
                            o.set({selectable: false, evented: false});
                        }
                        canvas.add(o);
                    });
                    canvas.renderAll();
                });
            }

            document.getElementById("pageInfo").innerText = `${pageNum} / ${pdfDoc.numPages}`;
            document.getElementById("jumpPage").value = pageNum;
            updateActiveToc(pageNum);
            updateModeUI();
        }

        // --- (è§¸ç™¼è¢å…‰ç­†èˆ‡åº•ç·š) ---
        document.addEventListener('mouseup', function() {
            const selection = window.getSelection();
            if (selection && selection.toString().trim() !== "") {
                setTimeout(() => {
                    if (interactionMode === 'highlight') {
                        highlightSelection(selection);
                    } else if (interactionMode === 'underline') {
                        underlineSelection(selection);
                    }
                }, 10);
            }
        });

        // è¢å…‰ç­†ç¹ªè£½
        function highlightSelection(selection) {
            if (selection.rangeCount === 0) 
                return;
            const selectedText = selection.toString(); 
            const range = selection.getRangeAt(0);
            const rawRects = range.getClientRects(); 
            const canvasRect = canvas.getElement().getBoundingClientRect();     
            const color = document.getElementById("mainColor").value;
            const rgbaColor = hexToRgba(color, 0.5);
            const mergedRects = mergeRects(rawRects);

            for (let i = 0; i < mergedRects.length; i++) {
                const r = mergedRects[i];
                const left = (r.left - canvasRect.left) / scale;
                const top = (r.top - canvasRect.top) / scale;
                const width = r.width / scale;
                const height = r.height / scale;

                const rect = new fabric.Rect({
                    left: left, top: top, width: width, height: height,
                    fill: rgbaColor, rx: 0, ry: 0,
                    selectable: false, evented: false,
                    data_type: 'highlight',
                    globalCompositeOperation: 'multiply',
                    selectedText: selectedText 
                });
                canvas.add(rect);
            }
            selection.removeAllRanges(); 
            canvas.renderAll();
            saveCurrent();
        }

        // åº•ç·šç¹ªè£½
        function underlineSelection(selection) {
            if (selection.rangeCount === 0) 
                return;

            const selectedText = selection.toString();
            const range = selection.getRangeAt(0);
            const rawRects = range.getClientRects(); 
            const canvasRect = canvas.getElement().getBoundingClientRect();
            const color = document.getElementById("mainColor").value;
            const mergedRects = mergeRects(rawRects);

            for (let i = 0; i < mergedRects.length; i++) {
                const r = mergedRects[i];              
                const left = (r.left - canvasRect.left) / scale;
                const top = (r.top - canvasRect.top) / scale;
                const width = r.width / scale;
                const height = r.height / scale;
                const lineHeight = 1; // åº•ç·šç²—ç´°
                const lineOffset = 0.2; // è·é›¢æ–‡å­—åº•éƒ¨

                const line = new fabric.Rect({
                    left: left,
                    top: top + height - lineOffset,
                    width: width,
                    height: lineHeight,
                    fill: color,
                    selectable: false, 
                    evented: false,
                    data_type: 'underline',
                    selectedText: selectedText 
                });
                canvas.add(line);
            }
            selection.removeAllRanges(); 
            canvas.renderAll();
            saveCurrent();
        }

        function mergeRects(rawRects) {
            const mergedRects = [];
            const tolerance = 2;
            for (let i = 0; i < rawRects.length; i++) {
                const r = rawRects[i];
                if (r.width === 0 || r.height === 0) continue;
                if (mergedRects.length > 0) {
                    const last = mergedRects[mergedRects.length - 1];
                    const sameLine = Math.abs(r.top - last.top) < tolerance && Math.abs(r.bottom - last.bottom) < tolerance;
                    const overlapping = r.left < last.right + tolerance;
                    if (sameLine && overlapping) {
                        const newRight = Math.max(last.right, r.right);
                        last.width = newRight - last.left;
                        last.right = newRight; 
                        last.height = Math.max(last.height, r.height);
                        continue; 
                    }
                }
                mergedRects.push({
                    left: r.left, top: r.top, right: r.right, bottom: r.bottom, width: r.width, height: r.height
                });
            }
            return mergedRects;
        }

        function hexToRgba(hex, alpha) {
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            return `rgba(${r}, ${g}, ${b}, ${alpha})`;
        }

        // --- UIç‹€æ…‹ ---
        function updateModeUI() {
            document.body.classList.remove("mode-text-select", "mode-drawing", "mode-object-edit", "mode-highlight", "mode-underline");
            
            const btnIds = ['drawBtn', 'stickyBtn', 'textBtn', 'selectObjBtn', 'highlightBtn', 'underlineBtn'];
            btnIds.forEach(id => {
                const btn = document.getElementById(id);
                if(btn) {
                    btn.classList.remove("active", "btn-secondary", "btn-primary", "btn-warning", "btn-dark");
                    
                    if(id === 'selectObjBtn') btn.classList.add("btn-outline-info");
                    else if(id === 'highlightBtn') btn.classList.add("btn-outline-primary");
                    else if(id === 'underlineBtn') btn.classList.add("btn-outline-dark");
                    else btn.classList.add("btn-outline-secondary");
                }
            });

            const highlights = canvas.getObjects().filter(o => o.data_type === 'highlight' || o.data_type === 'underline');

            if (interactionMode === 'text') {
                document.body.classList.add("mode-text-select");
                canvas.isDrawingMode = false;
                canvas.discardActiveObject();
                highlights.forEach(o => o.set({selectable: false, evented: false}));
            } 
            else if (interactionMode === 'highlight') {
                document.body.classList.add("mode-highlight"); 
                const btn = document.getElementById("highlightBtn");
                btn.classList.remove("btn-outline-warning");
                btn.classList.add("active", "btn-warning");
                
                canvas.isDrawingMode = false;
                canvas.discardActiveObject();
                highlights.forEach(o => o.set({selectable: false, evented: false}));
            }
            else if (interactionMode === 'underline') {
                document.body.classList.add("mode-underline"); 
                const btn = document.getElementById("underlineBtn");
                btn.classList.remove("btn-outline-dark");
                btn.classList.add("active", "btn-dark");
                
                canvas.isDrawingMode = false;
                canvas.discardActiveObject();
                highlights.forEach(o => o.set({selectable: false, evented: false}));
            }
            else if (interactionMode === 'draw') {
                document.body.classList.add("mode-drawing");
                const btn = document.getElementById("drawBtn");
                btn.classList.remove("btn-outline-secondary");
                btn.classList.add("active", "btn-secondary");
                
                canvas.isDrawingMode = true;
                canvas.freeDrawingBrush = new fabric.PencilBrush(canvas);
                updateStyle('brush');
                highlights.forEach(o => o.set({selectable: false, evented: false}));
            }
            else if (interactionMode === 'object' || interactionMode === 'sticky') {
                document.body.classList.add("mode-object-edit");
                
                if(interactionMode === 'object') {
                    const btn = document.getElementById("selectObjBtn");
                    btn.classList.remove("btn-outline-primary");
                    btn.classList.add("active", "btn-primary");
                    highlights.forEach(o => o.set({selectable: true, evented: true}));
                }
                
                if(interactionMode === 'sticky') {
                     const btn = document.getElementById("stickyBtn");
                     btn.classList.remove("btn-outline-secondary");
                     btn.classList.add("active", "btn-secondary");
                }
                canvas.isDrawingMode = false;
            }
            
            canvas.requestRenderAll();
        }

        function toggleHighlightMode() {
            interactionMode = (interactionMode === 'highlight') ? 'text' : 'highlight';
            updateModeUI();
        }
        function toggleUnderlineMode() {
            interactionMode = (interactionMode === 'underline') ? 'text' : 'underline';
            updateModeUI();
        }
        function toggleSelectObjectMode() {
            interactionMode = (interactionMode === 'object') ? 'text' : 'object';
            updateModeUI();
        }
        function toggleDrawMode() {
            interactionMode = (interactionMode === 'draw') ? 'text' : 'draw';
            updateModeUI();
        }
        function toggleStickyMode() {
            isStickyMode = !isStickyMode;
            interactionMode = isStickyMode ? 'sticky' : 'text';
            canvas.defaultCursor = isStickyMode ? 'crosshair' : 'default';
            updateModeUI();
        }

        function addText() {
            interactionMode = 'object'; 
            updateModeUI();
            const t = new fabric.IText("æ–‡å­—", { 
                left: 100, top: 100, fontSize: 20, 
                fill: document.getElementById("mainColor").value,
                fontFamily: document.getElementById("fontFamily").value,
                fontWeight: document.getElementById("boldBtn").classList.contains("active") ? 'bold' : 'normal'
            });
            canvas.add(t).setActiveObject(t);
            t.enterEditing();
            t.selectAll();
        }

        canvas.on('mouse:down', function(opt) {
            if (interactionMode === 'sticky' && !opt.target) {
                const p = canvas.getPointer(opt.e);
                const sticky = new fabric.Textbox("æ–°ä¾¿ç±¤", {
                    left: p.x, top: p.y, width: 80, fontSize: 11, fontFamily: 'Noto Sans TC',
                    backgroundColor: '#ffda6a', padding: 6, data_type: 'sticky', 
                    noteText: "", noteImage: null, hasControls: true, editable: false, 
                    rx: 6, ry: 6, textAlign: 'center'
                });
                sticky.set('text', getPreviewLabel("", false));
                canvas.add(sticky).setActiveObject(sticky);
                interactionMode = 'object'; 
                isStickyMode = false;
                updateModeUI();
            }
        });

        canvas.on('mouse:dblclick', function(opt) {
            if (opt.target && opt.target.data_type === 'sticky') {
                currentNoteObj = opt.target;
                document.getElementById('noteTextContent').value = currentNoteObj.noteText || "";
                tempNoteImage = currentNoteObj.noteImage;
                if (tempNoteImage) {
                    document.getElementById('noteImagePreview').src = tempNoteImage;
                    document.getElementById('noteImagePreviewContainer').style.display = 'block';
                } else {
                    removeNoteImage();
                }
                noteModal.show();
            }
        });

        function getPreviewLabel(str, hasImage) {
            let base = str ? (str.length > 8 ? str.substring(0, 8) + "..." : str) : "æ–°ä¾¿ç±¤";
            return hasImage ? "ğŸ“· " + base : "ğŸ·ï¸ " + base;
        }
        canvas.on('mouse:over', function(e) {
            const obj = e.target;
            if (obj && obj.data_type === 'sticky') {
                previewTxt.innerText = obj.noteText || "ç„¡è©³ç´°å…§å®¹";
                if (obj.noteImage) {
                    previewImg.src = obj.noteImage;
                    previewImg.style.display = 'block';
                } else {
                    previewImg.style.display = 'none';
                }
                hoverBox.style.display = 'block';
            }
        });
        canvas.on('mouse:move', function(e) {
            if (hoverBox.style.display === 'block') {
                hoverBox.style.left = (e.e.clientX + 15) + 'px';
                hoverBox.style.top = (e.e.clientY + 15) + 'px';
            }
        });
        canvas.on('mouse:out', function() { hoverBox.style.display = 'none'; });

        function updateStyle(type) {
            const color = document.getElementById("mainColor").value;
            const size = parseInt(document.getElementById("mainSize").value);
            const font = document.getElementById("fontFamily").value;
            const activeObjs = canvas.getActiveObjects();

            if (canvas.freeDrawingBrush) {
                const r = parseInt(color.slice(1,3), 16), g = parseInt(color.slice(3,5), 16), b = parseInt(color.slice(5,7), 16);
                canvas.freeDrawingBrush.color = `rgba(${r},${g},${b},0.6)`;
                canvas.freeDrawingBrush.width = size;
            }

            if (activeObjs.length > 0) {
                activeObjs.forEach(obj => {
                    if((obj.data_type === 'highlight' || obj.data_type === 'underline') && type === 'color') {
                        if(obj.data_type === 'highlight') obj.set('fill', hexToRgba(color, 0.5));
                        else obj.set('fill', color);
                    } 
                    else if (type === 'color' || type === 'init') {
                        if (obj.type === 'i-text' || obj.type === 'text') obj.set('fill', color);
                        else if (obj.type === 'path') obj.set('stroke', `rgba(${parseInt(color.slice(1,3), 16)},${parseInt(color.slice(3,5), 16)},${parseInt(color.slice(5,7), 16)},0.6)`);
                    }
                    if (type === 'size' && obj.data_type !== 'highlight' && obj.data_type !== 'underline') {
                        if (obj.type === 'path') obj.set('strokeWidth', size);
                    }
                    if (type === 'font') {
                        if (obj.type === 'i-text' || obj.type === 'text') obj.set('fontFamily', font);
                    }
                });
                canvas.requestRenderAll();
                saveCurrent();
            }
        }
        
        function toggleBold() { 
            const btn = document.getElementById("boldBtn");
            btn.classList.toggle("active");
            const isBold = btn.classList.contains("active");
            const activeObjs = canvas.getActiveObjects();
            if (activeObjs.length > 0) {
                activeObjs.forEach(obj => {
                    if (obj.type === 'i-text' || obj.type === 'text') {
                        obj.set('fontWeight', isBold ? 'bold' : 'normal');
                    }
                });
                canvas.requestRenderAll();
                saveCurrent();
            }
        }

        function saveCurrent() {
            const objects = canvas.getObjects().filter(o => !o.isBackground);
            if (!pdfDataInfo.mods) pdfDataInfo.mods = {};
            pdfDataInfo.mods[pageNum - 1] = objects.map(o => {
                let data = o.toObject([
                    'selectable', 'data_type', 'noteText', 'noteImage', 
                    'fill', 'stroke', 'strokeWidth', 'opacity', 'scaleX', 'scaleY', 
                    'text', 'fontSize', 'src', 'path', 'pathOffset', 'left', 'top', 
                    'width', 'height', 'backgroundColor', 'fontFamily', 'fontWeight', 
                    'rx', 'ry', 'globalCompositeOperation', 'selectedText'
                ]);
                
                if (o.type === 'path') {
                     const matrix = o.calcTransformMatrix();
                     data.abs_points = o.path.filter(p => p[0] === 'M' || p[0] === 'L').map(p => { 
                         return [
                             fabric.util.transformPoint({ x: p[1] - o.pathOffset.x, y: p[2] - o.pathOffset.y }, matrix).x, 
                             fabric.util.transformPoint({ x: p[1] - o.pathOffset.x, y: p[2] - o.pathOffset.y }, matrix).y
                         ]; 
                     });
                }
                return data;
            });
            localStorage.setItem("currentPdfSession", JSON.stringify(pdfDataInfo));
        }

        function changePage(d) { renderPage(pageNum + d); }
        function jumpToPage() { const p = parseInt(document.getElementById("jumpPage").value); renderPage(p); }      
        function adjustZoom(delta) { 
            saveCurrent();
            scale = Math.max(0.5, scale + delta); 
            document.getElementById("zoomLevel").innerText = Math.round(scale * 100) + "%"; 
            renderPage(pageNum); 
        }

        function fitToWidth() { 
            const wrap = document.getElementById('wrap'); 
            if(pdfDoc) {
                pdfDoc.getPage(pageNum).then(p => {
                     const vp = p.getViewport({scale: 1.0});
                     scale = (wrap.clientWidth - 50) / vp.width;
                     renderPage(pageNum);
                });
            }
        }

        function selectAll() {
            interactionMode = 'object';
            updateModeUI();
            canvas.discardActiveObject();
            const sel = new fabric.ActiveSelection(canvas.getObjects(), { canvas: canvas });
            canvas.setActiveObject(sel);
            canvas.requestRenderAll();
        }

        function deleteObj() { 
            const activeObjects = canvas.getActiveObjects();
            if (activeObjects.length) {
                canvas.discardActiveObject();
                activeObjects.forEach(function(object) { canvas.remove(object); });
                saveCurrent();
            }
        }
        
        async function download_save(btn, isDownload) {
            saveCurrent(); btn.innerHTML = 'è™•ç†ä¸­...'; btn.disabled = true;
            try {
                const r = await fetch("/save", { 
                    method: "POST", headers: { "Content-Type": "application/json" }, 
                    body: JSON.stringify({ doc_id: pdfDataInfo.doc_id, pdf_name: pdfDataInfo.pdf_name, original_name: pdfDataInfo.original_name, all_modifications: pdfDataInfo.mods }) 
                });
                if (r.ok) {
                    if (isDownload) { 
                        const blob = await r.blob(), url = window.URL.createObjectURL(blob), a = document.createElement('a'); 
                        a.href = url; a.download = pdfDataInfo.original_name.replace(".pdf","") + "_note.pdf"; a.click(); 
                    } else alert("å„²å­˜æˆåŠŸ");
                }
            } catch(e) { alert("å‡ºéŒ¯äº†"); } finally { btn.innerHTML = isDownload ? 'ä¸‹è¼‰' : 'å„²å­˜'; btn.disabled = false; }
        }

        function save(btn) { download_save(btn, false); }
        function download(btn) { download_save(btn, true); }

        async function analyzeStructure() {
            try {
                const r = await fetch("/analyze_toc", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ pdf_name: pdfDataInfo.pdf_name, toc_pages: document.getElementById("tocRange").value, offset: document.getElementById("pageOffset").value }) });
                const res = await r.json();
                const list = document.getElementById("resultList"); list.innerHTML = "";
                res.data.forEach(item => {
                    const a = document.createElement("a"); a.className = "list-group-item list-group-item-action d-flex justify-content-between align-items-center";
                    a.dataset.page = item.jump_page - 1; a.onclick = () => renderPage(parseInt(a.dataset.page));
                    a.innerHTML = `<span class="text-truncate">${item.title}</span><span class="badge bg-secondary">P.${item.page}</span>`;
                    list.appendChild(a);
                });
            } catch(e) { alert("ç›®éŒ„è§£æéŒ¯èª¤"); }
        }
        function updateActiveToc(pageIdx) {
            document.querySelectorAll('.list-group-item').forEach(el => el.classList.remove('active'));
            const items = Array.from(document.querySelectorAll('.list-group-item'));
            let activeItem = null;
            for (let item of items) { if (parseInt(item.dataset.page) <= pageIdx) activeItem = item; else break; }
            if (activeItem) { activeItem.classList.add('active'); activeItem.scrollIntoView({ behavior: 'smooth', block: 'center' }); }
        }

        document.addEventListener('keydown', e => { 
            if(e.key === 'Delete' && canvas.getActiveObject()) {
                const active = canvas.getActiveObject();
                if (!(active.isEditing)) deleteObj();
            }
            if ((e.ctrlKey || e.metaKey) && e.key === 'a') {
                e.preventDefault(); selectAll();
            }
        });
        
        function handleNoteImgChange(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = e => {
                    tempNoteImage = e.target.result;
                    document.getElementById('noteImagePreview').src = tempNoteImage;
                    document.getElementById('noteImagePreviewContainer').style.display = 'block';
                };
                reader.readAsDataURL(input.files[0]);
            }
        }
        function removeNoteImage() {
            tempNoteImage = null;
            document.getElementById('noteImgInput').value = "";
            document.getElementById('noteImagePreviewContainer').style.display = 'none';
        }
        function saveStickyContent() {
             if (currentNoteObj) {
                const val = document.getElementById('noteTextContent').value;
                currentNoteObj.set({ 
                    text: getPreviewLabel(val, !!tempNoteImage), 
                    noteText: val, noteImage: tempNoteImage 
                });
                noteModal.hide(); canvas.renderAll(); saveCurrent();
            }
        }

        document.getElementById("imgInput").onchange = function(e) { 
            const reader = new FileReader(); 
            reader.onload = f => fabric.Image.fromURL(f.target.result, img => { 
                img.scaleToWidth(200); 
                canvas.add(img).setActiveObject(img); 
                interactionMode = 'object'; updateModeUI();
            }); 
            reader.readAsDataURL(e.target.files[0]); 
        };

        async function addBlankPage() {
            if (!confirm(`ç¢ºå®šè¦åœ¨ç¬¬ ${currentPage + 1} é ä¹‹å¾Œæ’å…¥ç©ºç™½é å—ï¼Ÿ`)) return;
            saveCurrent(); isRefreshing = true;
            try {
                const r = await fetch("/add_blank_page", {
                    method: "POST", headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ doc_id: pdfDataInfo.doc_id, insert_after: currentPage, all_modifications: pdfDataInfo.mods })
                });
                const res = await r.json();
                if (res.success) {
                    pdfDataInfo.total_pages = res.new_total_pages; pdfDataInfo.mods = res.mods;
                    localStorage.setItem("currentPdfSession", JSON.stringify(pdfDataInfo));
                    renderPage(currentPage + 1);
                    alert("é é¢æ’å…¥æˆåŠŸï¼");
                }
            } catch(e) { alert("å¤±æ•—"); } finally { isRefreshing = false; }
        }

        async function deleteCurrentPage() {
            if (pdfDataInfo.total_pages <= 1) { alert("ç„¡æ³•åˆªé™¤æœ€å¾Œä¸€é "); return; }
            if (!confirm(`ç¢ºå®šè¦åˆªé™¤ç¬¬ ${currentPage + 1} é å—ï¼Ÿ`)) return;
            saveCurrent(); isRefreshing = true;
            try {
                const r = await fetch("/delete_page", {
                    method: "POST", headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ doc_id: pdfDataInfo.doc_id, page_idx: currentPage, all_modifications: pdfDataInfo.mods })
                });
                const res = await r.json();
                if (res.success) {
                    pdfDataInfo.total_pages = res.new_total_pages; pdfDataInfo.mods = res.mods;
                    localStorage.setItem("currentPdfSession", JSON.stringify(pdfDataInfo));
                    renderPage(currentPage >= pdfDataInfo.total_pages ? pdfDataInfo.total_pages - 1 : currentPage);
                    alert("é é¢å·²åˆªé™¤ï¼");
                }
            } catch(e) { alert("å¤±æ•—"); } finally { isRefreshing = false; }
        }
    </script>
</body>
</html>