<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç·¨è¼¯æ¨¡å¼ - PDFåšç­†è¨˜</title> 
    <link rel="icon" href="/static/logo.ico" type="image/x-icon"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <link rel="stylesheet" href="/static/css/edit.css">  
</head>
<body>
    <div id="hoverPreview">
        <div class="preview-text" id="previewText"></div>
        <img id="previewImg" src="" style="display:none;">
    </div>

    <div class="container-fluid p-0">
        <div class="row g-0 h-100">
            <div class="col-md-3 col-lg-2 sidebar">
                <div class="sidebar-header d-flex align-items-center justify-content-center py-3 border-bottom">
                    <a class="navbar-brand d-flex align-items-center gap-2 text-decoration-none" href="/">
                       <h5 class="m-0 fw-bold text-dark"><img src="/static/logo.png" alt="logo" style="height: 40px;">PDFåšç­†è¨˜</h5>
                    </a>
                </div>

                <div class="sidebar-content d-flex flex-column p-3">          
                    <div class="sidebar-panel mb-4">
                        <div class="d-grid gap-2">
                            <button class="btn btn-dark btn-sm fw-bold shadow-sm" onclick="addBlankPage()">
                                <i class="bi bi-plus-square me-2"></i>æ’å…¥ç©ºç™½é 
                            </button>
                            <button class="btn btn-outline-danger btn-sm fw-bold shadow-sm" onclick="deleteCurrentPage()">
                                <i class="bi bi-trash3 me-2"></i>åˆªé™¤æ­¤é 
                            </button>
                        </div>
                    </div>

                    <div class="sidebar-panel d-flex flex-column h-100">
                        <div class="mb-3">
                            <label class="form-label small text-muted">ç›®éŒ„é ç¢¼ç¯„åœ</label>
                            <input type="text" id="tocRange" class="form-control form-control-sm" value="3-5">
                        </div>
                        <div class="mb-3">
                            <label class="form-label small text-muted">é ç¢¼åç§»é‡</label>
                            <input type="number" id="pageOffset" class="form-control form-control-sm" value="0">
                        </div>
                        <button class="btn btn-success btn-sm w-100 fw-bold mb-3 shadow-sm" onclick="analyzeStructure()">
                           æ›¸ç±¤è£½ä½œ
                        </button>
                        
                        <div class="list-group list-group-flush border rounded overflow-auto shadow-sm" id="resultList" style="flex:1; min-height: 200px;">
                            <div class="p-4 text-center text-muted small bg-light">æœªè£½ä½œæ›¸ç±¤</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-9 col-lg-10 main-wrapper">
                <div class="toolbar-top d-flex align-items-center justify-content-between px-3 py-2">
                    <div class="d-flex align-items-center gap-3">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-file-text me-2 text-primary fs-5"></i>
                            <span id="fileNameDisplay" class="fw-bold text-dark text-truncate small" style="max-width:200px;">è¼‰å…¥ä¸­...</span>
                        </div>
                        <div class="vr mx-1"></div>
                        <div class="toolbar-group bg-white rounded border px-2 d-flex align-items-center">
                             <button class="btn btn-sm btn-link text-secondary" onclick="adjustZoom(-0.1)"><i class="bi bi-zoom-out"></i></button>
                             <span id="zoomLevel" class="small fw-bold text-muted mx-1" style="min-width:40px; text-align:center;">100%</span>
                             <button class="btn btn-sm btn-link text-secondary" onclick="adjustZoom(0.1)"><i class="bi bi-zoom-in"></i></button>
                             <div class="vr mx-2"></div>
                             <button class="btn btn-sm btn-link text-secondary" onclick="fitToWidth()" title="ç¬¦åˆå¯¬åº¦"><i class="bi bi-arrows-fullscreen"></i></button>
                        </div>
                    </div>

                    <div class="position-absolute start-50 translate-middle-x d-flex align-items-center bg-light rounded px-2 py-1 border page-control-group" style="z-index: 10;">
                        <button class="btn btn-sm btn-link text-dark p-0 me-2" onclick="changePage(-1)"><i class="bi bi-chevron-left"></i></button>
                        <span id="pageInfo" class="text-dark small mx-2 fw-bold" style="min-width: 60px; text-align: center;">0 / 0</span>
                        <button class="btn btn-sm btn-link text-dark p-0 ms-2 me-3" onclick="changePage(1)"><i class="bi bi-chevron-right"></i></button>
                        
                        <div class="input-group input-group-sm" style="width: 100px;">
                            <input type="number" id="jumpPage" class="form-control text-center" min="1" placeholder="#">
                            <button class="btn btn-outline-secondary" onclick="jumpToPage()">Go</button>
                        </div>
                    </div>

                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-success btn-sm px-3 fw-bold" onclick="save(this)">å„²å­˜</button>
                        <button class="btn btn-primary btn-sm px-3 fw-bold" onclick="download(this)">ä¸‹è¼‰</button>
                    </div>
                </div>

                <div id="wrap">
                    <canvas id="c"></canvas>
                </div>

                <div class="toolbar-bottom d-flex align-items-center justify-content-center gap-3">
                    <div class="d-flex align-items-center gap-2">
                        <input type="color" id="mainColor" value="#0a9bf5" class="form-control form-control-color form-control-sm border-0 shadow-sm" oninput="updateStyle('color')" title="ç­†åˆ·/æ–‡å­—é¡è‰²">
                        <input type="number" id="mainSize" value="20" class="form-control form-control-sm text-center shadow-sm" oninput="updateStyle('size')" style="width:60px" title="å¤§å° (px)">
                    </div>
                    <div class="vr mx-1"></div>
                    <div class="d-flex align-items-center gap-2">
                        <select id="fontFamily" class="form-select form-select-sm shadow-sm" style="width: 120px;" onchange="updateStyle('font')">
                            <option value="Noto Sans TC">æ€æºé»‘é«”</option>
                            <option value="Microsoft JhengHei">å¾®è»Ÿæ­£é»‘é«”</option>
                            <option value="Times New Roman" selected>Times New Roman</option>
                        </select>
                        <button id="boldBtn" class="btn btn-outline-secondary btn-sm shadow-sm" onclick="toggleBold()"><i class="bi bi-type-bold"></i></button>
                    </div>
                    <div class="vr mx-1"></div>
                    <div class="btn-group shadow-sm">
                        <button id="drawBtn" class="btn btn-outline-secondary btn-sm px-3" onclick="toggleDrawMode()"><i class="bi bi-pen"></i> ç¹ªåœ–</button>
                        <button class="btn btn-outline-secondary btn-sm px-3" onclick="addText()"><i class="bi bi-type"></i> æ–‡å­—</button>
                        <button id="stickyBtn" class="btn btn-outline-secondary btn-sm px-3" onclick="toggleStickyMode()"><i class="bi bi-chat-square-dots"></i> ä¾¿ç±¤</button>
                        <button class="btn btn-outline-secondary btn-sm px-3" onclick="document.getElementById('imgInput').click()"><i class="bi bi-image"></i> åœ–ç‰‡</button>
                    </div>
                    <input type="file" id="imgInput" hidden accept="image/*">
                    <div class="vr mx-1"></div>
                    <button class="btn btn-outline-secondary btn-sm shadow-sm px-3" onclick="selectAll()" title="å…¨é¸ (Ctrl+A)">å…¨é¸</button>
                    <button class="btn btn-outline-danger btn-sm shadow-sm px-3" onclick="deleteObj()">åˆªé™¤</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="noteModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered modal-sm">
            <div class="modal-content shadow border-0">
                <div class="modal-header bg-warning text-dark border-0 py-2">
                    <h6 class="modal-title fw-bold"><i class="bi bi-sticky me-2"></i>ä¾¿ç±¤å…§å®¹èˆ‡é™„ä»¶</h6>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <textarea id="noteTextContent" class="form-control mb-3" rows="4" placeholder="è¼¸å…¥è©³ç´°å…§å®¹..."></textarea>
                    <div id="noteImagePreviewContainer" class="text-center mb-2" style="display:none;">
                        <img id="noteImagePreview" class="img-thumbnail w-100" style="max-height: 150px; object-fit: contain;">
                        <button type="button" class="btn btn-sm btn-link text-danger text-decoration-none" onclick="removeNoteImage()">ç§»é™¤é™„ä»¶</button>
                    </div>
                    <button type="button" class="btn btn-outline-dark btn-sm w-100" onclick="document.getElementById('noteImgInput').click()">
                        <i class="bi bi-image me-1"></i>ä¸Šå‚³åœ–ç‰‡é™„ä»¶
                    </button>
                    <input type="file" id="noteImgInput" hidden accept="image/*" onchange="handleNoteImgChange(this)">
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-dark btn-sm w-100" onclick="saveStickyContent()">ç¢ºèªå„²å­˜</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const canvas = new fabric.Canvas("c", {
            preserveObjectStacking: true // å„ªåŒ–ï¼šé¸å–æ™‚ä¸æœƒå¼·åˆ¶æŠŠç‰©ä»¶æ‹‰åˆ°æœ€ä¸Šå±¤ï¼Œé«”é©—è¼ƒå¥½
        });
        const hoverBox = document.getElementById('hoverPreview');
        const previewTxt = document.getElementById('previewText');
        const previewImg = document.getElementById('previewImg');

        let pdfData = null, currentPage = 0, isFirstLoad = true, currentScale = 1.0;
        let originalWidth = 0, originalHeight = 0, isStickyMode = false, currentNoteObj = null;
        let isRefreshing = false, tempNoteImage = null;
        const noteModal = new bootstrap.Modal(document.getElementById('noteModal'));

        // --- ä¾¿ç±¤é¡¯ç¤ºèˆ‡æ‡¸æµ®é‚è¼¯ (ä¿æŒä¸è®Š) ---
        function getPreviewLabel(str, hasImage) {
            let base = str ? (str.length > 8 ? str.substring(0, 8) + "..." : str) : "æ–°ä¾¿ç±¤";
            return hasImage ? "ğŸ“· " + base : "ğŸ·ï¸ " + base;
        }

        canvas.on('mouse:over', function(e) {
            const obj = e.target;
            if (obj && obj.data_type === 'sticky') {
                previewTxt.innerText = obj.noteText || "ç„¡è©³ç´°å…§å®¹";
                if (obj.noteImage) {
                    previewImg.src = obj.noteImage;
                    previewImg.style.display = 'block';
                } else {
                    previewImg.style.display = 'none';
                }
                hoverBox.style.display = 'block';
            }
        });

        canvas.on('mouse:move', function(e) {
            if (hoverBox.style.display === 'block') {
                hoverBox.style.left = (e.e.clientX + 15) + 'px';
                hoverBox.style.top = (e.e.clientY + 15) + 'px';
            }
        });

        canvas.on('mouse:out', function() {
            hoverBox.style.display = 'none';
        });

        // --- å„ªåŒ–ï¼šäº‹ä»¶ç›£è½ï¼šé¸å–ç‰©ä»¶æ™‚ï¼ŒUI è‡ªå‹•æ›´æ–° ---
        canvas.on('selection:created', syncUIWithSelection);
        canvas.on('selection:updated', syncUIWithSelection);
        canvas.on('selection:cleared', () => {
            // å–æ¶ˆé¸å–æ™‚ï¼Œä¸éœ€è¦é‡ç½® UIï¼Œä¿ç•™ä¸Šæ¬¡è¨­å®šå³å¯ï¼Œæˆ–æ ¹æ“šéœ€æ±‚é‡ç½®
            document.getElementById("boldBtn").classList.remove("active");
        });

        function syncUIWithSelection(e) {
            const activeObj = e.selected[0];
            if (!activeObj) return;

            // å¦‚æœé¸å–çš„æ˜¯æ–‡å­—
            if (activeObj.type === 'i-text' || activeObj.type === 'text') {
                // æ›´æ–°é¡è‰²é¸æ“‡å™¨
                if (activeObj.fill && typeof activeObj.fill === 'string') {
                    // ç°¡å–®è½‰æ› hex (Fabric æœ‰æ™‚å›å‚³ rgb)
                    // é€™è£¡ç°¡åŒ–è™•ç†ï¼Œå‡è¨­ç”¨æˆ¶å¤šä½¿ç”¨å·¥å…·åˆ—é¸è‰²
                    if (activeObj.fill.startsWith('#')) {
                        document.getElementById("mainColor").value = activeObj.fill;
                    }
                }
                // æ›´æ–°å­—é«”
                document.getElementById("fontFamily").value = activeObj.fontFamily;
                // æ›´æ–°ç²—é«”æŒ‰éˆ•
                const isBold = activeObj.fontWeight === 'bold' || activeObj.fontWeight === 700;
                document.getElementById("boldBtn").classList.toggle("active", isBold);
                
                // é—œé–‰ç¹ªåœ–æ¨¡å¼ (å„ªåŒ–é«”é©—ï¼šé¸å­—æ™‚è‡ªå‹•é—œé–‰ç­†)
                if (canvas.isDrawingMode) toggleDrawMode();
            }
            // å¦‚æœé¸å–çš„æ˜¯ç­†è·¡ (Path)
            else if (activeObj.type === 'path') {
                if (activeObj.stroke) document.getElementById("mainColor").value = activeObj.stroke;
                if (activeObj.strokeWidth) document.getElementById("mainSize").value = activeObj.strokeWidth;
            }
        }

        // --- åˆå§‹åŒ– ---
        window.onload = function() {
            const storedData = localStorage.getItem("currentPdfSession");
            if (!storedData) { alert("è«‹å…ˆä¸Šå‚³æª”æ¡ˆ"); window.location.href = "/"; return; }
            pdfData = JSON.parse(storedData);
            document.getElementById("fileNameDisplay").innerText = pdfData.original_name;
            originalWidth = pdfData.width; originalHeight = pdfData.height;
            if (!pdfData.mods) pdfData.mods = {};
            setTimeout(() => { fitToWidth(); }, 100);
            
            // åˆå§‹åŒ–ç­†åˆ·
            updateStyle('init');
        };

        // --- é é¢ç®¡ç† (ä¿æŒä¸è®Š) ---
        async function addBlankPage() {
            if (!confirm(`ç¢ºå®šè¦åœ¨ç¬¬ ${currentPage + 1} é ä¹‹å¾Œæ’å…¥ç©ºç™½é å—ï¼Ÿ`)) return;
            saveCurrent(); isRefreshing = true;
            try {
                const r = await fetch("/add_blank_page", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ doc_id: pdfData.doc_id, insert_after: currentPage, all_modifications: pdfData.mods })
                });
                const res = await r.json();
                if (res.success) {
                    pdfData.total_pages = res.new_total_pages; pdfData.mods = res.mods;
                    localStorage.setItem("currentPdfSession", JSON.stringify(pdfData));
                    renderPage(currentPage + 1);
                    alert("é é¢æ’å…¥æˆåŠŸï¼");
                }
            } catch(e) { alert("é€£ç·šå¤±æ•—"); } finally { isRefreshing = false; }
        }

        async function deleteCurrentPage() {
            if (pdfData.total_pages <= 1) { alert("ç„¡æ³•åˆªé™¤æœ€å¾Œä¸€é "); return; }
            if (!confirm(`ç¢ºå®šè¦åˆªé™¤ç¬¬ ${currentPage + 1} é å—ï¼Ÿ`)) return;
            saveCurrent(); isRefreshing = true;
            try {
                const r = await fetch("/delete_page", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ doc_id: pdfData.doc_id, page_idx: currentPage, all_modifications: pdfData.mods })
                });
                const res = await r.json();
                if (res.success) {
                    pdfData.total_pages = res.new_total_pages; pdfData.mods = res.mods;
                    localStorage.setItem("currentPdfSession", JSON.stringify(pdfData));
                    renderPage(currentPage >= pdfData.total_pages ? pdfData.total_pages - 1 : currentPage);
                    alert("é é¢å·²åˆªé™¤ï¼");
                }
            } catch(e) { alert("é€£ç·šå¤±æ•—"); } finally { isRefreshing = false; }
        }

        // --- ä¾¿ç±¤ç·¨è¼¯èˆ‡é™„ä»¶ (ä¿æŒä¸è®Š) ---
        function handleNoteImgChange(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = e => {
                    tempNoteImage = e.target.result;
                    document.getElementById('noteImagePreview').src = tempNoteImage;
                    document.getElementById('noteImagePreviewContainer').style.display = 'block';
                };
                reader.readAsDataURL(input.files[0]);
            }
        }
        function removeNoteImage() {
            tempNoteImage = null;
            document.getElementById('noteImgInput').value = "";
            document.getElementById('noteImagePreviewContainer').style.display = 'none';
        }

        function toggleStickyMode() {
            isStickyMode = !isStickyMode;
            document.getElementById("stickyBtn").classList.toggle("active", isStickyMode);
            canvas.defaultCursor = isStickyMode ? 'crosshair' : 'default';
            // å¦‚æœé–‹å•Ÿä¾¿ç±¤ï¼Œè‡ªå‹•é—œé–‰ç¹ªåœ–æ¨¡å¼
            if(isStickyMode && canvas.isDrawingMode) toggleDrawMode();
        }

        canvas.on('mouse:down', function(opt) {
            // å¦‚æœåœ¨ä¾¿ç±¤æ¨¡å¼ä¸”æ²’æœ‰é»åˆ°ç‰©ä»¶
            if (isStickyMode && !opt.target) {
                const p = canvas.getPointer(opt.e);
                const sticky = new fabric.Textbox(getPreviewLabel("", false), {
                    left: p.x, top: p.y, width: 80, fontSize: 11, fontFamily: 'Noto Sans TC', 
                    backgroundColor: '#ffda6a', padding: 6, data_type: 'sticky', 
                    noteText: "", noteImage: null, hasControls: true, editable: false, 
                    rx: 6, ry: 6, textAlign: 'center'
                });
                canvas.add(sticky).setActiveObject(sticky);
                toggleStickyMode(); // åŠ å®Œä¸€å€‹å¾Œè‡ªå‹•åˆ‡æ›å›é¸å–æ¨¡å¼ï¼Œé«”é©—è¼ƒå¥½
            }
        });

        canvas.on('mouse:dblclick', function(opt) {
            if (opt.target && opt.target.data_type === 'sticky') {
                currentNoteObj = opt.target;
                document.getElementById('noteTextContent').value = currentNoteObj.noteText || "";
                tempNoteImage = currentNoteObj.noteImage;
                if (tempNoteImage) {
                    document.getElementById('noteImagePreview').src = tempNoteImage;
                    document.getElementById('noteImagePreviewContainer').style.display = 'block';
                } else { removeNoteImage(); }
                noteModal.show();
            }
        });

        function saveStickyContent() {
            if (currentNoteObj) {
                const val = document.getElementById('noteTextContent').value;
                currentNoteObj.set({ 
                    text: getPreviewLabel(val, !!tempNoteImage), 
                    noteText: val, 
                    noteImage: tempNoteImage 
                });
                noteModal.hide(); canvas.renderAll(); saveCurrent();
            }
        }

        // --- æ¸²æŸ“æ ¸å¿ƒ (ä¿æŒä¸è®Š) ---
        function renderPage(idx) {
            if (idx < 0 || idx >= pdfData.total_pages) return;
            if (!isFirstLoad && !isRefreshing && currentScale === window.lastRenderScale) saveCurrent();
            window.lastRenderScale = currentScale; currentPage = idx; isFirstLoad = false;
            
            document.getElementById("pageInfo").innerText = `${currentPage + 1} / ${pdfData.total_pages}`;
            document.getElementById("jumpPage").value = currentPage + 1;
            
            canvas.setWidth(originalWidth * currentScale); 
            canvas.setHeight(originalHeight * currentScale); 
            canvas.setZoom(currentScale);
            canvas.clear();
            
            fabric.Image.fromURL(`/get_page_image/${pdfData.pdf_name}/${currentPage}`, img => {
                img.set({ selectable: false, evented: false }).scaleToWidth(originalWidth);
                canvas.setBackgroundImage(img, canvas.renderAll.bind(canvas));
                if (pdfData.mods[currentPage]) {
                    fabric.util.enlivenObjects(pdfData.mods[currentPage], objs => {
                        objs.forEach(o => { 
                            if(o.data_type === 'sticky') o.set({hasControls:true, editable:false}); 
                            canvas.add(o); 
                        });
                        canvas.renderAll();
                    });
                }
            }, { crossOrigin: 'anonymous' });
            updateActiveToc(currentPage);
        }

        function saveCurrent() {
            const objects = canvas.getObjects().filter(o => !o.isBackground);
            pdfData.mods[currentPage] = objects.map(o => {
                let data = o.toObject(['selectable', 'data_type', 'noteText', 'noteImage', 'fill', 'stroke', 'strokeWidth', 'opacity', 'scaleX', 'scaleY', 'text', 'fontSize', 'src', 'path', 'pathOffset', 'left', 'top', 'width', 'height', 'backgroundColor', 'fontFamily', 'fontWeight']);
                // åº§æ¨™æ¨™æº–åŒ–
                if (o.type === 'path') {
                    const matrix = o.calcTransformMatrix();
                    data.abs_points = o.path.filter(p => p[0] === 'M' || p[0] === 'L').map(p => { 
                        return [
                            fabric.util.transformPoint({ x: p[1] - o.pathOffset.x, y: p[2] - o.pathOffset.y }, matrix).x, 
                            fabric.util.transformPoint({ x: p[1] - o.pathOffset.x, y: p[2] - o.pathOffset.y }, matrix).y
                        ]; 
                    });
                }
                return data;
            });
            localStorage.setItem("currentPdfSession", JSON.stringify(pdfData));
        }

        // --- åŸºæœ¬å·¥å…· ---
        function fitToWidth() { const wrap = document.getElementById('wrap'); applyZoom(Math.min((wrap.clientWidth - 50) / originalWidth, (wrap.clientHeight - 50) / originalHeight)); }
        function adjustZoom(delta) { applyZoom(Math.min(Math.max(currentScale + delta, 0.1), 5.0)); }
        function applyZoom(s) { if (!isFirstLoad) saveCurrent(); currentScale = s; document.getElementById("zoomLevel").innerText = Math.round(s * 100) + "%"; renderPage(currentPage); }
        function changePage(d) { renderPage(currentPage + d); }
        function jumpToPage() { const p = parseInt(document.getElementById("jumpPage").value) - 1; if(p>=0 && p<pdfData.total_pages) renderPage(p); }
        
        function deleteObj() { 
            const activeObjects = canvas.getActiveObjects();
            if (activeObjects.length) {
                canvas.discardActiveObject();
                activeObjects.forEach(function(object) {
                    canvas.remove(object);
                });
                saveCurrent(); // åˆªé™¤å¾Œè‡ªå‹•å„²å­˜
            }
        }
        
        // --- å„ªåŒ–ï¼šç¹ªåœ–æ¨¡å¼åˆ‡æ› ---
        function toggleDrawMode() { 
            canvas.isDrawingMode = !canvas.isDrawingMode; 
            const btn = document.getElementById("drawBtn");
            btn.classList.toggle("active", canvas.isDrawingMode);
            
            if(canvas.isDrawingMode){ 
                // é€²å…¥ç¹ªåœ–æ¨¡å¼
                if(isStickyMode) toggleStickyMode(); // å¦‚æœä¾¿ç±¤é–‹è‘—å°±é—œæ‰
                canvas.discardActiveObject(); // å–æ¶ˆç•¶å‰é¸å–
                canvas.requestRenderAll();
                
                canvas.freeDrawingBrush = new fabric.PencilBrush(canvas); 
                updateStyle('brush'); // å¥—ç”¨ç•¶å‰é¡è‰²å¤§å°
                canvas.defaultCursor = 'crosshair';
            } else {
                // é€€å‡ºç¹ªåœ–æ¨¡å¼ - é—œéµä¿®æ­£ï¼šç¢ºä¿è®Šå›å¯é¸å–ç‹€æ…‹
                canvas.defaultCursor = 'default';
                canvas.selection = true; // å…è¨±æ¡†é¸
                // é€™è£¡å¦‚æœä¸åšè™•ç†ï¼ŒFabric æœ‰æ™‚æœƒå¡ä½ï¼Œæ‰€ä»¥å¼·åˆ¶è¨­å› default
            }
        }

        // --- å„ªåŒ–ï¼šçµ±ä¸€çš„æ¨£å¼æ›´æ–°å‡½æ•¸ (é›™å‘ç¶å®š) ---
        // type: 'color', 'size', 'font', 'brush', 'init'
        function updateStyle(type) { 
            const color = document.getElementById("mainColor").value;
            const size = parseInt(document.getElementById("mainSize").value);
            const font = document.getElementById("fontFamily").value;
            const activeObjs = canvas.getActiveObjects();

            // 1. æ›´æ–°ç­†åˆ· (ç„¡è«–æœ‰ç„¡é¸å–ç‰©ä»¶ï¼Œç­†åˆ·è¨­å®šéƒ½è¦æ›´æ–°ï¼Œä¾›ä¸‹æ¬¡ç¹ªåœ–ç”¨)
            if (canvas.freeDrawingBrush) {
                // å°‡ hex è½‰ç‚º rgba å¢åŠ é€æ˜åº¦ï¼Œæ¨¡æ“¬è¢å…‰ç­†æ•ˆæœ (å¯é¸)
                // é€™è£¡ä¿æŒåŸæœ¬é‚è¼¯ï¼Œä½¿ç”¨åŠé€æ˜
                const r = parseInt(color.slice(1,3), 16), g = parseInt(color.slice(3,5), 16), b = parseInt(color.slice(5,7), 16);
                canvas.freeDrawingBrush.color = `rgba(${r},${g},${b},0.6)`;
                canvas.freeDrawingBrush.width = size;
            }

            // 2. å¦‚æœæœ‰é¸å–ç‰©ä»¶ï¼Œå³æ™‚æ”¹è®Šå®ƒå€‘çš„å±¬æ€§
            if (activeObjs.length > 0 && type !== 'brush' && type !== 'init') {
                activeObjs.forEach(obj => {
                    if (type === 'color' || type === 'init') {
                        if (obj.type === 'i-text' || obj.type === 'text') {
                            obj.set('fill', color);
                        } else if (obj.type === 'path') {
                            obj.set('stroke', `rgba(${parseInt(color.slice(1,3), 16)},${parseInt(color.slice(3,5), 16)},${parseInt(color.slice(5,7), 16)},0.6)`);
                        }
                    }
                    if (type === 'size') {
                        // ç­†è·¡æ”¹ç²—ç´°ï¼Œæ–‡å­—å¯é¸æ”¹å­—è™Ÿ(é€™è£¡æš«ä¸æ”¹æ–‡å­—å¤§å°ä»¥å…æ’ç‰ˆäº‚æ‰ï¼Œæˆ–å¯è¦–éœ€æ±‚é–‹å•Ÿ)
                        if (obj.type === 'path') obj.set('strokeWidth', size);
                        // if (obj.type === 'i-text') obj.set('fontSize', size); 
                    }
                    if (type === 'font') {
                        if (obj.type === 'i-text' || obj.type === 'text') {
                            obj.set('fontFamily', font);
                        }
                    }
                });
                canvas.requestRenderAll();
                saveCurrent(); // ä¿®æ”¹å¾Œè‡ªå‹•å„²å­˜
            }
        }

        // ç²—é«”åˆ‡æ› (æ”¯æ´é¸å–ä¿®æ”¹)
        function toggleBold() { 
            const btn = document.getElementById("boldBtn");
            btn.classList.toggle("active");
            const isBold = btn.classList.contains("active");
            
            const activeObjs = canvas.getActiveObjects();
            if (activeObjs.length > 0) {
                activeObjs.forEach(obj => {
                    if (obj.type === 'i-text' || obj.type === 'text') {
                        obj.set('fontWeight', isBold ? 'bold' : 'normal');
                    }
                });
                canvas.requestRenderAll();
                saveCurrent();
            }
        }

        function addText() { 
            // é»æ“Šæ–‡å­—æ™‚ï¼Œè‡ªå‹•é—œé–‰ç¹ªåœ–æ¨¡å¼
            if(canvas.isDrawingMode) toggleDrawMode();

            const t = new fabric.IText("æ–‡å­—", { 
                left: 100, top: 100, fontSize: 20, 
                fill: document.getElementById("mainColor").value, 
                fontFamily: document.getElementById("fontFamily").value,
                fontWeight: document.getElementById("boldBtn").classList.contains("active") ? 'bold' : 'normal'
            }); 
            canvas.add(t).setActiveObject(t); 
            // æ–°å¢å¾Œè‡ªå‹•èšç„¦ï¼Œæ–¹ä¾¿ç›´æ¥æ‰“å­—
            t.enterEditing();
            t.selectAll();
        }

        // --- å„ªåŒ–ï¼šå…¨é¸åŠŸèƒ½ ---
        function selectAll() {
            canvas.discardActiveObject();
            const sel = new fabric.ActiveSelection(canvas.getObjects().filter(o => !o.isBackground), { 
                canvas: canvas,
            });
            canvas.setActiveObject(sel);
            canvas.requestRenderAll();
        }

        // --- å„²å­˜èˆ‡ä¸‹è¼‰ (ä¿æŒä¸è®Š) ---
        async function download_save(btn, isDownload) {
            saveCurrent(); btn.innerHTML = 'è™•ç†ä¸­...'; btn.disabled = true;
            try {
                const r = await fetch("/save", { 
                    method: "POST", 
                    headers: { "Content-Type": "application/json" }, 
                    body: JSON.stringify({ doc_id: pdfData.doc_id, pdf_name: pdfData.pdf_name, original_name: pdfData.original_name, all_modifications: pdfData.mods }) 
                });
                if (r.ok) {
                    if (isDownload) { 
                        const blob = await r.blob(), url = window.URL.createObjectURL(blob), a = document.createElement('a'); 
                        a.href = url; a.download = pdfData.original_name.replace(".pdf","") + "_note.pdf"; a.click(); 
                    } else alert("å„²å­˜æˆåŠŸ");
                }
            } catch(e) { alert("å‡ºéŒ¯äº†"); } finally { btn.innerHTML = isDownload ? 'ä¸‹è¼‰' : 'å„²å­˜'; btn.disabled = false; }
        }
        function save(btn) { download_save(btn, false); }
        function download(btn) { download_save(btn, true); }

        // --- ç›®éŒ„è§£æ (ä¿æŒä¸è®Š) ---
        async function analyzeStructure() {
            try {
                const r = await fetch("/analyze_toc", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ pdf_name: pdfData.pdf_name, toc_pages: document.getElementById("tocRange").value, offset: document.getElementById("pageOffset").value }) });
                const res = await r.json();
                const list = document.getElementById("resultList"); list.innerHTML = "";
                res.data.forEach(item => {
                    const a = document.createElement("a"); a.className = "list-group-item list-group-item-action d-flex justify-content-between align-items-center";
                    a.dataset.page = item.jump_page - 1; a.onclick = () => renderPage(parseInt(a.dataset.page));
                    a.innerHTML = `<span class="text-truncate">${item.title}</span><span class="badge bg-secondary">P.${item.page}</span>`;
                    list.appendChild(a);
                });
            } catch(e) { alert("ç›®éŒ„è§£æå‡ºéŒ¯"); }
        }

        function updateActiveToc(pageIdx) {
            document.querySelectorAll('.list-group-item').forEach(el => el.classList.remove('active'));
            const items = Array.from(document.querySelectorAll('.list-group-item'));
            let activeItem = null;
            for (let item of items) { if (parseInt(item.dataset.page) <= pageIdx) activeItem = item; else break; }
            if (activeItem) { activeItem.classList.add('active'); activeItem.scrollIntoView({ behavior: 'smooth', block: 'center' }); }
        }

        // --- éµç›¤å¿«æ·éµ ---
        document.addEventListener('keydown', e => { 
            // Delete åˆªé™¤
            if(e.key === 'Delete' && canvas.getActiveObject()) {
                // é¿å…åœ¨æ‰“å­—æ™‚åˆªé™¤ç‰©ä»¶
                const active = canvas.getActiveObject();
                if (!(active.isEditing)) deleteObj();
            }
            // Ctrl+A å…¨é¸
            if ((e.ctrlKey || e.metaKey) && e.key === 'a') {
                e.preventDefault(); // é˜²æ­¢é¸ä¸­ç¶²é æ–‡å­—
                selectAll();
            }
        });

        document.getElementById("imgInput").onchange = function(e) { const reader = new FileReader(); reader.onload = f => fabric.Image.fromURL(f.target.result, img => { img.scaleToWidth(200); canvas.add(img).setActiveObject(img); }); reader.readAsDataURL(e.target.files[0]); };
    </script> 
</body>
</html>